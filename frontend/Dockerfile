# ==============================================================================
# Base ステージ: 依存関係のインストール（共通）
# ==============================================================================
FROM node:24-alpine AS base

# corepackでpnpm管理（公式推奨）
RUN corepack enable

WORKDIR /app

# lockファイル→パッケージ定義 順でキャッシュ効率UP
COPY pnpm-lock.yaml .
COPY package.json .

# 依存インストール（ロック厳守、キャッシュ活用）
RUN pnpm install --frozen-lockfile

# ==============================================================================
# Build ステージ: アプリケーションのビルド
# ==============================================================================
FROM base AS build

# アプリケーションコードコピー
COPY . .

# ビルド実行
RUN pnpm build

# ==============================================================================
# Development ステージ: 開発環境用
# ==============================================================================
FROM base AS development

# アプリケーションコードコピー
COPY . .

# 非rootユーザー作成と所有権設定（セキュリティ向上）
RUN adduser -D appuser && \
    chown -R appuser:appuser /app

# 非rootユーザーに切り替え
USER appuser

EXPOSE 5173

# 開発サーバー起動
CMD ["pnpm", "dev", "--host", "0.0.0.0"]

# ==============================================================================
# Production ステージ: 本番環境用（S3 + CloudFront）
# ==============================================================================
FROM build AS production

# S3へのデプロイ用にワークディレクトリを設定(ビルド済みファイルは既に /app/dist に存在)
WORKDIR /app
